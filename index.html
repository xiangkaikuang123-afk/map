<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurant Roulette Dark Mode</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
:root {
  --primary: #00b14f;
  --primary-dark: #009b45;
  --bg: #121212;
  --bg-panel: #1e1e1e;
  --text: #ffffff;
  --text-secondary: #bbbbbb;
}
*{box-sizing:border-box;}
body, html {
  margin:0;
  padding:0;
  font-family: 'Inter', Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100%;
}

#topBar {
  width:100%;
  padding:15px;
  background:var(--primary);
  color:white;
  font-size:22px;
  font-weight:600;
  text-align:center;
  box-shadow:0 2px 10px rgba(0,0,0,0.3);
}

#searchSection {
  position: relative;
  max-width: 600px;
  margin: 15px auto;
}
#searchBox {
  width:100%;
  padding:12px 16px;
  font-size:18px;
  border:none;
  border-radius:25px;
  outline:none;
  background: var(--bg-panel);
  color:white;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
#suggestions {
  position: absolute;
  top:50px;
  width:100%;
  background: var(--bg-panel);
  border-radius:0 0 20px 20px;
  overflow:hidden;
  max-height:250px;
  overflow-y:auto;
  display:none;
  opacity:0;
  transition:opacity 0.3s ease;
  box-shadow:0 6px 18px rgba(0,0,0,0.5);
  z-index:1000;
}
.suggestItem {
  padding:12px 16px;
  cursor:pointer;
  border-bottom:1px solid #333;
  color: var(--text);
  transition: background 0.2s;
}
.suggestItem:last-child {border-bottom:none;}
.suggestItem:hover {background: rgba(0,177,79,0.2);}

#map { height:60vh; width:100%; }

#controls {
  text-align:center;
  padding:15px;
}
#pickRestaurant {
  background: var(--primary);
  color:white;
  border:none;
  padding:14px 25px;
  border-radius:25px;
  font-size:20px;
  cursor:pointer;
  transition:0.3s;
}
#pickRestaurant:hover { background: var(--primary-dark); }

.leaflet-popup-content { font-size:16px; color:var(--text); }
.leaflet-popup-content a { color:#00b14f; text-decoration:none; }
.leaflet-popup-content a:hover { text-decoration:underline; }

.review {
  margin-top:5px;
  padding:5px;
  border-top:1px solid #333;
  font-size:14px;
  color: var(--text-secondary);
}
.rating { color:#ffb400; font-weight:bold; }

/* ========================= */
/*      MOBILE OPTIMIZED     */
/* ========================= */

@media (max-width: 768px) {

  #topBar {
    font-size: 18px;
    padding: 12px;
  }

  #searchSection {
    margin: 10px auto;
    max-width: 90%;
  }

  #searchBox {
    font-size: 16px;
    padding: 10px 14px;
  }

  #suggestions {
    max-height: 200px;
  }

  #map {
    height: 55vh;
  }

  #controls {
    padding: 10px;
  }

  #pickRestaurant {
    font-size: 16px;
    padding: 12px 20px;
    border-radius: 20px;
  }

  .leaflet-popup-content {
    font-size: 14px;
  }

  .leaflet-popup-content b {
    font-size: 16px;
  }
}

/* Very small devices */
@media (max-width: 480px) {

  #map {
    height: 50vh;
  }

  #pickRestaurant {
    font-size: 15px;
    padding: 10px 18px;
  }

  #searchBox {
    font-size: 15px;
  }
}
</style>
</head>

<body>

<div id="topBar">Restaurant Roulette</div>

<div id="searchSection">
  <input id="searchBox" type="text" placeholder="Search location (Malaysia)..." autocomplete="off">
  <div id="suggestions"></div>
</div>

<div id="map"></div>

<div id="controls">
  <button id="pickRestaurant">Pick Random Restaurant</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

let map = L.map('map').setView([3.1390,101.6869],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

let selectedLocation = null;
let userMarker = null;
let restaurants = [];
let currentMarker = null;

/* Auto detect user */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    selectedLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    map.setView([selectedLocation.lat, selectedLocation.lng],16);
    userMarker = L.marker(selectedLocation,{draggable:true}).addTo(map);
    userMarker.on("dragend",e=>{
      selectedLocation = e.target.getLatLng();
      restaurants=[]; if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
    });
  }, ()=>console.warn("Geolocation denied"));
}

/* Click map to set location */
map.on("click",e=>{
  selectedLocation = e.latlng;
  restaurants=[];

  if(!userMarker){
    userMarker=L.marker(e.latlng,{draggable:true}).addTo(map);
    userMarker.on("dragend",evt=>{
      selectedLocation=evt.target.getLatLng();
      restaurants=[]; if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
    });
  } else userMarker.setLatLng(e.latlng);

  if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
});

/* Search autocomplete */
const searchBox = document.getElementById("searchBox");
const suggestionsBox = document.getElementById("suggestions");
let suggestionTimeout;

searchBox.addEventListener("input",()=>{
  const q=searchBox.value.trim();
  clearTimeout(suggestionTimeout);

  if(q.length<2){
    suggestionsBox.style.opacity=0;
    setTimeout(()=>{suggestionsBox.style.display="none"},300);
    return;
  }

  suggestionTimeout=setTimeout(async()=>{
    const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&countrycodes=MY&q=${encodeURIComponent(q)}`);
    const data=await res.json();
    suggestionsBox.innerHTML="";

    data.forEach(r=>{
      const item=document.createElement("div");
      item.className="suggestItem";
      item.textContent=r.display_name;
      item.onclick=()=>{
        selectedLocation={lat:r.lat,lng:r.lon};
        map.setView([r.lat,r.lon],16);

        if(!userMarker) userMarker=L.marker([r.lat,r.lon],{draggable:true}).addTo(map);
        else userMarker.setLatLng([r.lat,r.lon]);

        restaurants=[];
        if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }

        suggestionsBox.style.opacity=0;
        setTimeout(()=>{suggestionsBox.style.display="none"},300);
      };
      suggestionsBox.appendChild(item);
    });

    suggestionsBox.style.display="block";
    setTimeout(()=>{suggestionsBox.style.opacity=1},10);
  },300);
});

/* Fetch nearby restaurants */
async function fetchNearby(lat,lon){
  const query=`[out:json][timeout:25];
               node["amenity"="restaurant"](around:1200,${lat},${lon});
               out;`;

  const url="https://overpass-api.de/api/interpreter?data="+encodeURIComponent(query);
  const resp=await fetch(url);
  const data=await resp.json();

  return data.elements.map(el=>({
    name:el.tags.name || "Unnamed Restaurant",
    lat:el.lat,
    lon:el.lon
  }));
}

/* Fake reviews placeholder (replace anytime) */
async function getReviews(name){
  return [
    {provider:'Yelp', reviewRating:4, reviewText:'Nice place!'},
    {provider:'Google', reviewRating:5, reviewText:'Excellent food.'}
  ];
}

/* Pick random restaurant */
async function pickRestaurant(){
  if(!selectedLocation) return alert("Location not set yet.");

  if(restaurants.length===0){
    restaurants=await fetchNearby(selectedLocation.lat,selectedLocation.lng);
    if(restaurants.length===0) return alert("No restaurants nearby.");
  }

  const picked = restaurants[Math.floor(Math.random()*restaurants.length)];

  if(currentMarker) map.removeLayer(currentMarker);
  currentMarker = L.marker([picked.lat,picked.lon]).addTo(map);

  let popupHtml = `
    <b style="color:black;">${picked.name}</b><br>
    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(picked.name)}" target="_blank">
      Open in Google Maps
    </a>
  `;

  const reviews = await getReviews(picked.name);
  if(reviews.length>0){
    reviews.slice(0,3).forEach(r=>{
      popupHtml += `<div class="review"><b>${r.provider}</b> — ⭐ ${r.reviewRating}<br>"${r.reviewText}"</div>`;
    });
  } else {
    popupHtml += `<div class="review">No public reviews found.</div>`;
  }

  currentMarker.bindPopup(popupHtml).openPopup();
  map.setView([picked.lat,picked.lon],16);
}

document.getElementById("pickRestaurant").onclick=pickRestaurant;

</script>
</body>
</html>
