<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Restaurant Roulette with Search Suggestions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; }
    
    #search-bar {
      padding:10px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap:10px;
      background:#f0f0f0;
      position:relative;
    }
    #searchInput { width:300px; padding:8px; font-size:16px; }
    #suggestions {
      position:absolute;
      top:45px; /* below the input */
      left:0;
      width:300px;
      background:#fff;
      border:1px solid #ccc;
      max-height:150px;
      overflow-y:auto;
      z-index:1000;
      display:none;
    }
    .suggestion-item { padding:5px; cursor:pointer; }
    .suggestion-item:hover { background:#eee; }
    
    #map { height:85vh; width:100%; }
    #controls { height:5vh; display:flex; justify-content:center; align-items:center; gap:10px; }
    button { padding:8px 16px; font-size:16px; cursor:pointer; }
    .leaflet-popup-content { font-size:16px; }
    .restaurant-link { font-weight:bold; color:#007BFF; text-decoration:none; }
    .restaurant-link:hover { text-decoration:underline; }
    .review { margin-top:5px; padding:5px; border-top:1px solid #ccc; }
    .rating { color:#ff9900; font-weight:bold; }
  </style>
</head>
<body>

<div id="search-bar">
  <input id="searchInput" type="text" placeholder="Type a place or address">
  <button id="searchBtn">Search</button>
  <div id="suggestions"></div>
</div>

<div id="map"></div>
<div id="controls">
  <button id="pickRestaurant">Pick Random Restaurant</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([3.1390, 101.6869], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

  let restaurants = [];
  let selectedLocation = null;
  let userMarker = null;
  const suggestionsDiv = document.getElementById('suggestions');
  const countryCode = 'MY'; // Malaysia

  async function fetchNearbyOSM(lat, lon) {
    const query = `[out:json][timeout:25];
      node["amenity"="restaurant"](around:1000,${lat},${lon});
      out;`;
    const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
    const resp = await fetch(url);
    const data = await resp.json();
    return data.elements.map(el => ({
      name: el.tags.name || 'Unnamed Restaurant',
      lat: el.lat,
      lon: el.lon
    }));
  }

  async function getReviews(restaurantName) {
    try {
      const resp = await fetch('/getReviews', {
        method: 'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ query: restaurantName, location: selectedLocation })
      });
      const data = await resp.json();
      return data.reviews || [];
    } catch(e) {
      console.error('Error fetching reviews', e);
      return [];
    }
  }

  async function pickRandomRestaurant() {
    if (!selectedLocation) {
      alert('Select location first (click map, allow geolocation, or search)');
      return;
    }
    if (restaurants.length === 0) {
      restaurants = await fetchNearbyOSM(selectedLocation.lat, selectedLocation.lng);
      if (restaurants.length === 0) {
        alert('No restaurants found nearby');
        return;
      }
    }
    const picked = restaurants[Math.floor(Math.random() * restaurants.length)];
    const reviews = await getReviews(picked.name);
    let reviewHtml = '';
    if (reviews.length > 0) {
      reviews.slice(0,3).forEach(r => {
        reviewHtml += `<div class="review"><strong>${r.provider}</strong> — ⭐ ${r.reviewRating || ''} — "${r.reviewText}"</div>`;
      });
    } else {
      reviewHtml = '<div class="review">No public reviews found.</div>';
    }

    const link = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(picked.name)}`;
    L.popup()
      .setLatLng([picked.lat, picked.lon])
      .setContent(`<b>${picked.name}</b><br><a class="restaurant-link" href="${link}" target="_blank">Open in Google Maps</a>${reviewHtml}`)
      .openOn(map);
  }

  async function searchPlace(query) {
    if (!query) {
      suggestionsDiv.style.display = 'none';
      return;
    }
    const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=${countryCode}&q=${encodeURIComponent(query)}`;
    const resp = await fetch(url);
    const results = await resp.json();

    suggestionsDiv.innerHTML = '';
    if(results.length > 0) {
      suggestionsDiv.style.display = 'block';
      results.slice(0,5).forEach(place => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = place.display_name;
        div.addEventListener('click', () => {
          selectPlace(place);
          suggestionsDiv.innerHTML = '';
          suggestionsDiv.style.display = 'none';
        });
        suggestionsDiv.appendChild(div);
      });
    } else {
      suggestionsDiv.style.display = 'none';
    }
  }

  function selectPlace(place) {
    selectedLocation = { lat: parseFloat(place.lat), lng: parseFloat(place.lon) };
    map.setView([selectedLocation.lat, selectedLocation.lng], 16);
    if (!userMarker) {
      userMarker = L.marker(selectedLocation, { draggable:true }).addTo(map);
      userMarker.on('dragend', evt => {
        selectedLocation = evt.target.getLatLng();
        restaurants = [];
      });
    } else {
      userMarker.setLatLng([selectedLocation.lat, selectedLocation.lng]);
    }
    restaurants = [];
  }

  map.on('click', e => {
    selectedLocation = e.latlng;
    restaurants = [];
    if (!userMarker) {
      userMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
      userMarker.on('dragend', evt => {
        selectedLocation = evt.target.getLatLng();
        restaurants = [];
      });
    } else {
      userMarker.setLatLng(e.latlng);
    }
  });

  document.getElementById('pickRestaurant').addEventListener('click', pickRandomRestaurant);
  document.getElementById('searchBtn').addEventListener('click', () => {
    const query = document.getElementById('searchInput').value.trim();
    searchPlace(query);
  });
  document.getElementById('searchInput').addEventListener('input', (e) => {
    searchPlace(e.target.value.trim());
  });

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      selectedLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.setView([selectedLocation.lat, selectedLocation.lng], 16);
      userMarker = L.marker(selectedLocation, { draggable:true }).addTo(map);
      userMarker.on('dragend', evt => {
        selectedLocation = evt.target.getLatLng();
        restaurants = [];
      });
    }, err => console.warn('Geolocation denied'));
  }
</script>
</body>
</html>
